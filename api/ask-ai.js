export default async function handler(req, res) {
  // 设置CORS头，允许所有来源访问
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,POST,OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  // 处理OPTIONS预检请求
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  // 只处理POST请求
  if (req.method !== 'POST') {
    return res.status(405).json({ error: '只支持POST请求' });
  }
  
  try {
    const { question } = req.body;
    
    if (!question) {
      return res.status(400).json({ error: '请提供问题' });
    }
    
    // 这里使用模拟回复，确保基本功能
    const answer = getSmartAnswer(question);
    
    res.status(200).json({
      success: true,
      reply: answer,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('API错误:', error);
    res.status(500).json({
      success: false,
      error: '服务器内部错误'
    });
  }
}

// 智能回答生成函数
function getSmartAnswer(question) {
  const q = question.toLowerCase().trim();
  
  // 行测相关问题
  if (q.includes('行测') || q.includes('数量') || q.includes('言语') || q.includes('判断')) {
    return `# 行测备考全面指南

## 📊 最新考试趋势
根据2026年考试大纲，行测有以下变化：
1. **言语理解**：增加政治理论内容，占比提升
2. **数量关系**：减少纯计算，增加应用题
3. **判断推理**：图形推理难度增加
4. **资料分析**：数据更贴近工作实际
5. **常识判断**：时政比例提升至60%

## 🎯 备考策略
**第一阶段（1-15天）**：基础学习，掌握各模块知识点
**第二阶段（16-30天）**：专项练习，提高解题速度
**第三阶段（31-45天）**：真题模拟，查漏补缺

## 💡 提分技巧
1. **时间管理**：言语30min，判断35min，资料25min，数量15min，常识5min，涂卡10min
2. **答题顺序**：先做擅长模块，数量放最后
3. **猜题技巧**：选项代入法、排除法、相似选项法

需要详细讲解哪个模块？`;
  }
  
  // 申论相关问题
  else if (q.includes('申论') || q.includes('作文') || q.includes('写作')) {
    return `# 申论高分秘籍

## 📝 五段三分式结构

### 第一段：开头（150字）
时代背景 + 问题引出 + 中心论点
示例："当前...面临...挑战，如何...成为关键。因此，必须..."

### 第二段：分论点一（200字）
观点句 + 理论论证 + 事例论证
示例："首先，...是基础。正如...所说..."

### 第三段：分论点二（200字）
观点句 + 正反论证 + 对策建议
示例："其次，...是关键。如果...就会...；反之..."

### 第四段：分论点三（200字）
观点句 + 多角度分析 + 升华
示例："最后，...是保障。从个人...社会...国家..."

### 第五段：结尾（150字）
总结观点 + 意义升华 + 展望未来
示例："综上所述，...让我们共同努力..."

## 🏆 加分要点
1. 标题新颖（对仗式、比喻式）
2. 引用恰当（领导人讲话、名言）
3. 卷面整洁，字迹工整
4. 段落分明，逻辑清晰`;
  }
  
  // 备考计划
  else if (q.includes('计划') || q.includes('备考') || q.includes('时间') || q.includes('30天')) {
    return `# 30天高效备考计划

## 📅 第一阶段：基础夯实（第1-10天）

### 每日安排（8小时）
**上午**（8:00-12:00）：
- 8:00-9:00：行测理论学习
- 9:00-10:30：行测模块练习
- 10:30-12:00：错题整理

**下午**（14:00-18:00）：
- 14:00-16:00：申论理论学习
- 16:00-17:30：申论小题练习
- 17:30-18:00：素材积累

**晚上**（20:00-22:00）：
- 时政热点学习

## 📅 第二阶段：专项突破（第11-20天）

### 每日安排（9小时）
**上午**（8:00-12:00）：行测模考+分析
**下午**（14:00-18:00）：申论模考+分析
**晚上**（19:00-21:00）：薄弱环节专项

## 📅 第三阶段：冲刺模拟（第21-28天）

### 每日安排（10小时）
**上午**（8:30-11:00）：行测真题
**下午**（14:00-17:00）：申论真题
**晚上**（19:00-21:00）：复盘总结

## 📅 第四阶段：调整放松（第29-30天）

### 第29天：错题回顾+时政梳理
### 第30天：检查用品+熟悉考场+调整心态

## 💡 关键提醒
1. 每周日休息半天
2. 每天保证7小时睡眠
3. 饮食清淡营养
4. 适当运动放松`;
  }
  
  // 面试相关
  else if (q.includes('面试') || q.includes('结构化') || q.includes('面谈')) {
    return `# 公务员面试完全攻略

## 🎭 面试形象
**男生**：深色西装 + 白衬衫 + 领带 + 黑皮鞋
**女生**：套装/套裙 + 淡妆 + 包头鞋

## 💬 结构化面试五大题型

### 1. 综合分析题
**结构**：是什么 + 为什么 + 怎么办
**示例**：先解释现象，再分析原因影响，最后提出对策

### 2. 组织管理题
**结构**：前期准备 + 中期实施 + 后期总结
**示例**：调研→方案→宣传→执行→评估

### 3. 应急应变题
**原则**：生命至上→现场控制→分层处理→信息公开→总结反思

### 4. 人际关系题
**原则**：工作为重→自我反思→主动沟通→坚持原则

### 5. 情景模拟题
**技巧**：进入角色→语气恰当→解决问题→自然结尾

## 🏋️‍♂️ 30天训练计划
**第1-10天**：掌握框架
**第11-20天**：大量练习
**第21-30天**：全真模拟`;
  }
  
  // 默认回答
  else {
    return `# 公考智能助手为您解答

您好！我是您的公考备考助手。

## 🎯 我能为您提供：
1. **行测指导**：言语理解、数量关系、判断推理、资料分析、常识判断
2. **申论辅导**：大作文框架、小题技巧、素材积累
3. **面试培训**：结构化面试、应急应变、组织管理
4. **备考规划**：长期计划、短期安排、时间管理

## 📚 学习建议
**基础阶段**：系统学习知识点
**强化阶段**：分模块练习
**冲刺阶段**：真题模拟
**调整阶段**：查漏补缺

## 💡 请具体提问
为了更好地帮助您，请告诉我：
1. 您备考的**具体科目**
2. 您的**备考时间**
3. 您的**薄弱环节**

例如：
- "行测数量关系怎么学"
- "申论大作文怎么写"
- "帮我制定60天计划"

我会根据您的具体情况提供个性化建议！

祝您备考顺利！🚀`;
  }
}
